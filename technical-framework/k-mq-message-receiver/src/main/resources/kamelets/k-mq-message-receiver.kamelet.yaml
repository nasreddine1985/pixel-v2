apiVersion: camel.apache.org/v1alpha1
kind: Kamelet
metadata:
  name: k-mq-message-receiver
  labels:
    camel.apache.org/kamelet.type: "source"
spec:
  definition:
    title: "K-MQ Message Receiver"
    description: "Consumes messages from IBM MQ, logs receipt details, and routes messages for further processing"
    required: [destination]
    properties:
      destination:
        title: "MQ destination (queue)"
        type: string
        default: "${mq.destination}"
      jmsConnectionFactoryRef:
        title: "JMS Connection Factory Bean name"
        type: string
        default: "${mq.connectionFactoryRef}"
  template:
    from:
      uri: "jms:queue:{{destination}}"
      parameters:
        connectionFactory: "#{{jmsConnectionFactoryRef}}"
      steps:
        - log: 
            message: "[MQ-RECEIVER] Message received from queue {{destination}}: ${body}"
            loggingLevel: "INFO"
        
        - set-header:
            name: "messageSource"
            constant: "IBM_MQ"
        
        - set-header:
            name: "receiptTimestamp"
            simple: "${date:now:yyyy-MM-dd HH:mm:ss.SSS}"
        
        - set-header:
            name: "receiptChannel"
            constant: "MQ_SERIES"
        
        - set-header:
            name: "mqQueue"
            simple: "{{destination}}"
        
        - log: 
            message: "[MQ-RECEIVER] Message metadata set - Source: ${header.messageSource}, Timestamp: ${header.receiptTimestamp}, Queue: ${header.mqQueue}"
            loggingLevel: "DEBUG"
