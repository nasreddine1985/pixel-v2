apiVersion: camel.apache.org/v1alpha1
kind: Kamelet
metadata:
  name: k-log-flow-summary
  labels:
    camel.apache.org/kamelet.type: "action"
spec:
  definition:
    title: "K-Log Flow Summary"
    description: |-
      Creates and publishes flow summary logs to Kafka for PACS008 processing monitoring
    type: object
    properties:
      step:
        title: Processing Step
        description: Current processing step
        type: string
      kafkaTopicName:
        title: Kafka Topic Name
        description: Kafka topic for flow summary logs
        type: string
      brokers:
        title: Kafka Brokers
        description: Kafka broker endpoints
        type: string
  template:
    from:
      uri: "kamelet:source"
      steps:
        - setHeader:
            name: "logMessage"
            simple: |
              {"flowOccurId":"${header.flowOccurId}","flowCode":"${header.flowCode}","flowStatusCode":"{{step}}","flowCountryCode":"${header.flowCountryCode}","flowCountryId":"${header.flowCountryId}","flowTypeId":1,"flowComment":"${header.flowCode} payment processing {{step}}","nbOutExpected":1,"nbOutCompleted":0,"nbError":0,"nbRemitance":0,"nbTransaction":1,"nbReplay":0,"issuingPartnerCode":"MQ_ACTIVEMQ","issuingPartnerLink":"tcp://pixel-v2-activemq:61616","recipientPartnerCode":"KAFKA_CLUSTER","recipientPartnerLink":"kafka:29092","lastLogId":"LOG-${date:now:yyyyMMddHHmmssSSS}","lastLogComponent":"pacs008-processing-flow","lastLogDatetime":"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSSSS}","lastLogStatusCode":"SUCCESS","lastUpdateDatetime":"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSSSS}","lastUpdateUser":"system","inputFilePath":"pacs008.input.queue","inputFileSize":"${bodyAs(String).length()}B","beginFlowDatetime":"${header.beginFlowDateTime}","currentClientDatetime":"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSSSS}","beginFlowDate":"${header.beginFlowDate}","lastUpdateDate":"${date:now:yyyy-MM-dd}","region":"EU"}
        - setHeader:
            name: "kafka.KEY"
            simple: "${header.flowOccurId}"
        - setHeader:
            name: "originalBody"
            simple: "${body}"
        - setBody:
            simple: "${header.logMessage}"
        - log:
            message: "K-LOG-FLOW-SUMMARY: logMessage=${header.logMessage}"
            loggingLevel: DEBUG
        - log:
            message: "K-LOG-FLOW-SUMMARY: body=${body}"
            loggingLevel: DEBUG
        - to:
            uri: "kafka:{{kafkaTopicName}}?brokers={{brokers}}&keySerializer=org.apache.kafka.common.serialization.StringSerializer&valueSerializer=org.apache.kafka.common.serialization.StringSerializer"
        - setBody:
            simple: "${header.originalBody}"
        - removeHeader:
            name: "originalBody"
        # Send to sink
        - to: "kamelet:sink"
