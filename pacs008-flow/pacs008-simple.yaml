#!/usr/bin/env jbang camel@apache/camel run "$0" "$@"

# //DEPS org.apache.camel:camel-bom:4.1.0@pom
# //DEPS org.apache.camel:camel-core
# //DEPS org.apache.camel:camel-yaml-dsl
# //DEPS org.apache.camel:camel-jms
# //DEPS org.apache.activemq:activemq-client:5.18.3
# //DEPS ch.qos.logback:logback-classic:1.4.11

# PACS-008 Simple Flow - Testing JBang YAML Route with ActiveMQ
# Simplified version without external properties files

# Bean Configuration
- beans:
  - name: "activeMQConnectionFactory"
    type: "org.apache.activemq.ActiveMQConnectionFactory"
    properties:
      brokerURL: "tcp://host.docker.internal:61617"
      userName: "admin" 
      password: "admin"
      trustAllPackages: true

# Simple Test Route
- route:
    id: "pacs008-simple-test-route"
    from:
      uri: "jms:queue:pacs008.input.queue?connectionFactory=#activeMQConnectionFactory&concurrentConsumers=1"
      steps:
        # Step 1: Basic logging
        - setHeader:
            name: "CorrelationId"
            simple: "${header.JMSMessageID}"
        - log:
            message: "[PACS-008-SIMPLE] Received message - CorrelationId: ${header.CorrelationId}, MessageId: ${header.JMSMessageID}"
        - log:
            message: "[PACS-008-SIMPLE] Message body: ${body}"
            
        # Step 2: Send to output queue
        - to:
            uri: "jms:queue:pacs008.output.queue?connectionFactory=#activeMQConnectionFactory"
        - log:
            message: "[PACS-008-SIMPLE] Message processed successfully - CorrelationId: ${header.CorrelationId}"

# Error Handler Configuration
- errorHandler:
    deadLetterChannel:
      uri: "jms:queue:pacs008.error.queue?connectionFactory=#activeMQConnectionFactory"
      redeliveryPolicy:
        maximumRedeliveries: 3
        redeliveryDelay: 1000