# PIXEL-V2 Docker Infrastructure
# Complete stack for PIXEL-V2 application deployment

services:
  
  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    container_name: pixel-v2-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - pixel-v2-network
    restart: unless-stopped

  # Apache Kafka Message Broker
  kafka:
    build: 
      context: ./kafka
      dockerfile: Dockerfile
    hostname: kafka
    container_name: pixel-v2-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - pixel-v2-network
    restart: unless-stopped
    healthcheck:
      test: kafka-topics --bootstrap-server localhost:9092 --list
      interval: 30s
      timeout: 10s
      retries: 5

  # PostgreSQL Database
  postgresql:
    build:
      context: ./postgresql
      dockerfile: Dockerfile
    hostname: postgresql
    container_name: pixel-v2-postgresql
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: pixelv2
      POSTGRES_USER: pixelv2
      POSTGRES_PASSWORD: pixelv2_secure_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_logs:/var/log/postgresql
    networks:
      - pixel-v2-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -p 5432 -U pixelv2 -d pixelv2"]
      interval: 30s
      timeout: 10s
      retries: 5


  # ActiveMQ Classic Message Broker
  activemq:
    image: rmohr/activemq:latest
    container_name: pixel-v2-activemq
    ports:
      - "61616:61616"
      - "8161:8161"
    environment:
      ACTIVEMQ_ADMIN_LOGIN: admin
      ACTIVEMQ_ADMIN_PASSWORD: admin
    networks:
      - pixel-v2-network
    restart: unless-stopped

  # Redis Cache for Flow Configuration
  redis:
    image: redis:7-alpine
    hostname: redis
    container_name: pixel-v2-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - pixel-v2-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PIXEL-V2 Camel Runtime Application - Instance 1
  pixel-v2-app-1:
    build:
      context: ./camel-runtime-jbang
      dockerfile: Dockerfile
    hostname: pixel-v2-app-1
    container_name: pixel-v2-camel-1
    depends_on:
      - postgresql
      - kafka
    ports:
      - "8080:8080"    # HTTP/REST API
      - "8778:8778"    # JMX
      - "9779:9779"    # Metrics
    environment:
      PIXEL_ENV: production
      PIXEL_DB_URL: jdbc:postgresql://postgresql:5432/pixelv2
      PIXEL_DB_USERNAME: pixelv2
      PIXEL_DB_PASSWORD: pixelv2_secure_password
      PIXEL_MQ_URL: tcp://pixel-v2-activemq:61616
      PIXEL_MQ_USERNAME: admin
      PIXEL_MQ_PASSWORD: admin
      PIXEL_KAFKA_BOOTSTRAP: kafka:29092
      ROUTE_FILE: "pacs008-complete.yaml"
      JAVA_OPTS: "-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./routes:/opt/pixel-v2/routes:ro
      - app_logs_1:/opt/pixel-v2/logs
    networks:
      - pixel-v2-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/observe/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PIXEL-V2 Camel Runtime Application - Instance 2
  pixel-v2-app-2:
    build:
      context: ./camel-runtime-jbang
      dockerfile: Dockerfile
    hostname: pixel-v2-app-2
    container_name: pixel-v2-camel-2
    depends_on:
      - postgresql
      - kafka
    ports:
      - "8081:8080"    # HTTP/REST API
      - "8781:8778"    # JMX
      - "9781:9779"    # Metrics
    environment:
      PIXEL_ENV: production
      PIXEL_DB_URL: jdbc:postgresql://postgresql:5432/pixelv2
      PIXEL_DB_USERNAME: pixelv2
      PIXEL_DB_PASSWORD: pixelv2_secure_password
      PIXEL_MQ_URL: tcp://pixel-v2-activemq:61616
      PIXEL_MQ_USERNAME: admin
      PIXEL_MQ_PASSWORD: admin
      PIXEL_KAFKA_BOOTSTRAP: kafka:29092
      ROUTE_FILE: "pacs008-log.yaml"
      JAVA_OPTS: "-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./routes:/opt/pixel-v2/routes:ro
      - app_logs_2:/opt/pixel-v2/logs
    networks:
      - pixel-v2-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/observe/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # PIXEL-V2 Camel Spring Boot Application
  pixel-v2-app-spring-1:
    build: 
      context: ./camel-runtime-spring
      dockerfile: Dockerfile
    image: pixel-v2-app-spring-1:latest
    container_name: pixel-v2-app-spring-1
    hostname: pixel-v2-app-spring-1
    restart: unless-stopped
    depends_on:
      - postgresql
      - kafka
      - activemq
      - redis
    environment:
      # Spring Boot Configuration
      SPRING_PROFILES_ACTIVE: prod
      JAVA_OPTS: "-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Djava.security.egd=file:/dev/./urandom -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=8778 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
      
      # Database Configuration
      PIXEL_DB_HOST: postgresql
      PIXEL_DB_PORT: 5432
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/pixelv2
      SPRING_DATASOURCE_USERNAME: pixelv2
      SPRING_DATASOURCE_PASSWORD: pixelv2_secure_password
      
      # ActiveMQ Configuration  
      PIXEL_ACTIVEMQ_HOST: activemq
      PIXEL_ACTIVEMQ_PORT: 61616
      PIXEL_ACTIVEMQ_BROKER_URL: tcp://activemq:61616
      PIXEL_ACTIVEMQ_USERNAME: admin
      PIXEL_ACTIVEMQ_PASSWORD: admin
      
      # Kafka Configuration
      CAMEL_COMPONENT_KAFKA_BROKERS: kafka:29092
      CH_LOG_KAFKA_BROKERS: kafka:29092
      KMQ_STARTER_BROKERS: kafka:29092
      
      # Redis Configuration for k-identification kamelet
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      PIXEL_REFERENTIEL_SERVICE_URL: http://pixel-v2-referentiel:8099
      PIXEL_KAFKA_BROKERS: kafka:29092
      PIXEL_CACHE_TTL: 3600
      
      # Application Configuration
      SERVER_PORT: 8080
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics,camel,jolokia,prometheus
      
    ports:
      - "8082:8080"   # Application port
      - "8782:8778"   # JMX port
    volumes:
      - pixel_v2_app_spring_1_logs:/opt/pixel-v2-app-spring-1/logs
    networks:
      - pixel-v2-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # pgAdmin for PostgreSQL management (optional)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pixel-v2-pgadmin
    depends_on:
      - postgresql
    ports:
      - "8091:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pixel-v2.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - pixel-v2-network
    restart: unless-stopped
    profiles:
      - tools

  # Kafdrop for Kafka management (optional)
  kafdrop:
    image: obsidiandynamics/kafdrop:3.30.0
    container_name: pixel-v2-kafdrop
    depends_on:
      - kafka
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:29092
      JVM_OPTS: "-Xms32M -Xmx64M"
    networks:
      - pixel-v2-network
    restart: unless-stopped
    profiles:
      - tools

  # Hawt.io for Camel Route Management
  hawtio:
    build:
      context: ./hawtio
      dockerfile: Dockerfile
    container_name: pixel-v2-hawtio
    depends_on:
      - pixel-v2-app-1
      - pixel-v2-app-spring-1
    ports:
      - "8090:8080"
    environment:
      HAWTIO_PROXYWHITELIST: "pixel-v2-app-1,pixel-v2-app-2,pixel-v2-app-spring-1,localhost,127.0.0.1,172.19.0.*,172.20.0.*,172.21.0.*"
      HAWTIO_PROXY_HOST: pixel-v2-app-1
      HAWTIO_PROXY_PORT: 8080
      HAWTIO_AUTH_ENABLED: "false"
      HAWTIO_LOCAL_ADDRESS_PROBING: "false"
      JAVA_OPTS: "-Xms128m -Xmx256m -Dhawtio.proxyAllowlist=pixel-v2-app-1,pixel-v2-app-2,pixel-v2-app-spring-1,localhost,127.0.0.1,172.19.0.*,172.20.0.*,172.21.0.* -Dhawtio.authenticationEnabled=false -Dhawtio.localAddressProbing=false"
    networks:
      - pixel-v2-network
    restart: unless-stopped
    profiles:
      - tools

# Volumes for data persistence
volumes:
  postgres_data:
    name: pixel-v2-postgres-data
  postgres_logs:
    name: pixel-v2-postgres-logs
  pgadmin_data:
    name: pixel-v2-pgadmin-data
  app_logs_1:
    name: pixel-v2-app-logs-1
  app_logs_2:
    name: pixel-v2-app-logs-2
  pixel_v2_app_spring_1_logs:
    name: pixel-v2-app-spring-1-logs
  redis_data:
    name: pixel-v2-redis-data

# Networks
networks:
  pixel-v2-network:
    name: pixel-v2-network
    driver: bridge