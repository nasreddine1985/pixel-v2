#!/usr/bin/env jbang camel@apache/camel run "$0" "$@"

# //DEPS org.apache.camel:camel-bom:4.1.0@pom
# //DEPS org.apache.camel:camel-core
# //DEPS org.apache.camel:camel-kamelet
# //DEPS org.apache.camel:camel-yaml-dsl
# //DEPS org.apache.camel:camel-jms
# //DEPS org.apache.camel:camel-jdbc
# //DEPS org.apache.camel:camel-sql
# //DEPS org.apache.camel:camel-xpath
# //DEPS org.apache.camel:camel-xslt
# //DEPS org.apache.camel:camel-http
# //DEPS org.apache.camel:camel-kafka
# //DEPS org.apache.camel:camel-jpa
# //DEPS org.apache.activemq:activemq-client-jakarta:6.0.1
# //DEPS jakarta.jms:jakarta.jms-api:3.1.0
# //DEPS jakarta.persistence:jakarta.persistence-api:3.1.0
# //DEPS org.hibernate.orm:hibernate-core:6.2.13.Final
# //DEPS org.postgresql:postgresql:42.6.0
# //DEPS ch.qos.logback:logback-classic:1.4.11



# Technical Framework Dependencies - All Kamelet JARs (Latest Version: 1.0.1-SNAPSHOT)
# //REPOS maven-local=file:///Users/n.abassi/.m2/repository
# //DEPS com.pixel.v2:k-mq-message-receiver:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-http-message-receiver:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-cft-data-receiver:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-kafka-starter:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-kafka-message-publisher:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-message-concat:1.0.1-SNAPSHOT  
# //DEPS com.pixel.v2:k-message-split:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-db-tx:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-log-tx:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-referentiel-data-loader:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-ingestion-technical-validation:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-payment-idempotence-helper:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-xsd-validation:1.0.1-SNAPSHOT
# //DEPS com.pixel.v2:k-xsl-transformation:1.0.1-SNAPSHOT

# PIXEL-V2 Main Route - Entry Point for All Message Processing
# This is the main route that orchestrates all payment processing flows

- beans:
  - name: "messageConcatenationProcessor"
    type: "com.pixel.v2.aggregation.processor.MessageConcatenationProcessor"
  - name: "messageConcatenationStrategy"
    type: "com.pixel.v2.aggregation.strategy.MessageConcatenationStrategy"
  - name: "xsdValidationProcessor"
    type: "com.pixel.v2.validation.processor.XsdValidationProcessor"
  - name: "xslTransformationProcessor"
    type: "com.pixel.v2.transformation.processor.XslTransformationProcessor"
  - name: "jmsConnectionFactory"
    type: "org.apache.activemq.ActiveMQConnectionFactory"
    properties:
      brokerURL: "tcp://pixel-v2-activemq:61616"
      username: "admin"
      password: "admin"
      trustAllPackages: true
  - name: "dataSource"
    type: "org.postgresql.ds.PGSimpleDataSource"
    properties:
      serverName: "pixel-v2-postgresql"
      portNumber: 5432
      databaseName: "pixelv2"
      user: "pixelv2"
      password: "pixelv2_secure_password"

# Main PACS-008 Processing Route - Complete Production Flow with MQ Integration
- route:
    id: "pacs008-processing-flow-yaml"
    errorHandler:
      deadLetterChannel:
        deadLetterUri: "direct:pacs008-error-handler"
        useOriginalMessage: true
    from:
      # Step 1: Receive messages from ActiveMQ using k-mq-message-receiver kamelet
      uri: "kamelet:k-mq-message-receiver?destination=pacs008.input.queue&connectionFactory=#jmsConnectionFactory&concurrentConsumers=1"
      steps:
        # Step 1: Initial logging with correlation ID from MQ message
        - setHeader:
            name: "MessageId"
            simple: "${header.JMSMessageID}"
        - setHeader:
            name: "CorrelationId"
            simple: "${header.JMSMessageID}"
        - setProperty:
            name: "CurrentStep"
            constant: "MESSAGE_RECEIPT"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"message-received\",\"message\":\"[PACS-008] Message received from MQ - Queue: pacs008.input.queue, CorrelationId: ${header.CorrelationId}, MessageId: ${header.MessageId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"flowCode\":\"PACS008\",\"messageId\":\"${header.MessageId}\",\"step\":\"STARTED\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"queue\":\"pacs008.input.queue\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-flow-summary&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 2: Message Aggregation (k-message-concat) with proper parameters
        - to:
            uri: "kamelet:k-message-concat"
            parameters:
              correlationId: "${header.messageID}"  
              size: 1
              timeout: 1
              parallelProcessing: false
        - setProperty:
            name: "CurrentStep"
            constant: "MESSAGE_AGGREGATION"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"message-aggregation\",\"message\":\"[PACS-008] Message aggregation completed - CorrelationId: ${header.CorrelationId}, BatchSize: ${header.AggregationCount}, AggregationCompleted: ${header.AggregationCompleted}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 3: Database Persistence using k-db-tx kamelet
        - setHeader:
            name: "messageType"
            constant: "PACS008"
        - setHeader:
            name: "source"
            constant: "MQ"
        - setHeader:
            name: "payload"
            simple: "${body}"
        - setHeader:
            name: "PersistenceStartTime"
            simple: "${date:now}"
        - setProperty:
            name: "CurrentStep"
            constant: "MESSAGE_PERSISTENCE"
        
        - to:
            uri: "kamelet:k-db-tx-messages?dataSource=#dataSource&tableName=pixel_v2.tb_messages"
        - setHeader:
            name: "PersistenceStatus"
            constant: "SUCCESS"
        - setHeader:
            name: "PersistenceRecordId"
            simple: "${header.messageId}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"message-persistence\",\"message\":\"[PACS-008] Message persisted completed - PersistenceRecordId: ${header.PersistenceRecordId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"flowCode\":\"PACS008\",\"messageId\":\"${header.MessageId}\",\"step\":\"IN_PROGRESS\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"queue\":\"pacs008.input.queue\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-flow-summary&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"


        
        # Step 4: Simple logging (skipping referential data loading for now - requires service setup)
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"WARN\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"referential-data-loading-skip\",\"message\":\"[PACS-008] Skipping referential data loading (requires service setup) - CorrelationId: ${header.CorrelationId}\"}"
        - setProperty:
            name: "CurrentStep"
            constant: "MESSAGE_REFERENTIAL_DATA_LOADING_SKIP"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 5: XSD Validation of PACS008 messages 
        - setHeader:
            name: "ValidationStartTime"
            simple: "${date:now}"
        - setProperty:
            name: "CurrentStep"
            constant: "PACS008_XSD_VALIDATION"
        - to:
            uri: "kamelet:k-xsd-validation-custom?xsdFileName=pacs.008.001.08.xsd&validationMode=LENIENT&enableDetailedErrors=true&logValidationResult=true"
        - setHeader:
            name: "ValidationDuration"
            simple: "${date:now} - ${header.ValidationStartTime}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"xsd-validation\",\"message\":\"[PACS-008] PACS008 XSD validation successful - Schema: pacs.008.001.08.xsd, Duration: ${header.ValidationDuration}ms, CorrelationId: ${header.CorrelationId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 6: XSL Transformation to CDM format (k-xsl-transformation)
        - setHeader:
            name: "TransformationStartTime"
            simple: "${date:now}"
        - setProperty:
            name: "CurrentStep"
            constant: "PACS008_XSL_TRANSFORMATION"
        - to:
            uri: "kamelet:k-xsl-transformation?xslFileName=pacs-008-to-simplified.xsl&transformationMode=LENIENT&enableDetailedErrors=true&logTransformationResult=true"
        - setHeader:
            name: "TransformationDuration"
            simple: "${date:now} - ${header.TransformationStartTime}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"xsl-transformation\",\"message\":\"[PACS-008] XSL transformation completed - Stylesheet: pacs-008-to-simplified.xsl, Duration: ${header.TransformationDuration}ms, CorrelationId: ${header.CorrelationId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
                    
        # Step 7: CDM XSD Validation of transformed messages (k-xsd-validation)
        - setHeader:
            name: "CdmValidationStartTime"
            simple: "${date:now}"
        - setProperty:
            name: "CurrentStep"
            constant: "CDM_XSD_VALIDATION"
        - to:
            uri: "kamelet:k-xsd-validation-custom?xsdFileName=ISO_Business_ITL_Pivot-v2-Simple.xsd&validationMode=LENIENT&enableDetailedErrors=true&logValidationResult=true"
        - setHeader:
            name: "CdmValidationDuration"
            simple: "${date:now} - ${header.CdmValidationStartTime}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"cdm-xsd-validation\",\"message\":\"[PACS-008] CDM XSD validation successful - Schema: ISO_Business_ITL_Pivot-v2-Simple.xsd, Duration: ${header.CdmValidationDuration}ms, CorrelationId: ${header.CorrelationId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 8: Message Split processing (k-message-split kamelet has technical issues)
        - setHeader:
            name: "SplitStartTime"
            simple: "${date:now}"
        - setHeader:
            name: "SplitCount"
            constant: "1"
        - setHeader:
            name: "CamelSplitIndex"
            constant: "0"
        - setHeader:
            name: "SplitDuration"
            simple: "${date:now} - ${header.SplitStartTime}"
        - setProperty:
            name: "CurrentStep"
            constant: "MESSAGE_SPLIT"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"message-split\",\"message\":\"[PACS-008] Message split completed - Strategy: SINGLE_MESSAGE, Count: ${header.SplitCount}, Index: ${header.CamelSplitIndex}, Duration: ${header.SplitDuration}ms, CorrelationId: ${header.CorrelationId}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
            
        # Step 9: Send individual messages to Kafka using k-kafka-message-publisher kamelet
        - setHeader:
            name: "KafkaTopic"
            constant: "pacs008-output"
        - setHeader:
            name: "ProcessingTimestamp"
            simple: "${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}"
        - setProperty:
            name: "CurrentStep"
            constant: "KAFKA_MESSAGE_PUBLISH"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-output&brokers=kafka:29092&key=${header.CorrelationId}&requestTimeoutMs=5000&connectionMaxIdleMs=5000"
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"kafka-output\",\"message\":\"[PACS-008] MESSAGE SENT TO KAFKA TOPIC: ${header.KafkaTopic} - Key: ${header.kafka.KEY}, CorrelationId: ${header.CorrelationId}, MessageSize: ${body.length()}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"
        - setHeader:
            name: "LogMessage"
            simple: "{\"flowCode\":\"PACS008\",\"messageId\":\"${header.MessageId}\",\"step\":\"COMPLETED\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"queue\":\"pacs008.input.queue\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-flow-summary&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"


        
# Error Handler Route - Handles errors from main processing flow with detailed error tracking
- route:
    id: "pacs008-error-handler-route"
    from:
      uri: "direct:pacs008-error-handler"
      steps:
        # Capture detailed error information
        - setHeader:
            name: "ErrorTimestamp"
            simple: "${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}"
        - choice:
            when:
              - simple: "${header.CorrelationId} != null"
                steps:
                  - setHeader:
                      name: "ErrorCorrelationId"
                      simple: "${header.CorrelationId}"
            otherwise:
              steps:
                - setHeader:
                    name: "ErrorCorrelationId"
                    simple: "error-${date:now:yyyyMMddHHmmssSSS}"
        
        # Capture exception details
        - setHeader:
            name: "ExceptionClass"
            simple: "${exception.class.simpleName}"
        - setHeader:
            name: "ExceptionMessage"
            simple: "${exception.message}"
        - setHeader:
            name: "ExceptionStackTrace"
            simple: "${exception.stacktrace}"
        - setHeader:
            name: "ProcessingStep"
            simple: "${exchangeProperty.CurrentStep}"
        - setHeader:
            name: "ExchangeId"
            simple: "${exchangeId}"
        - setHeader:
            name: "RouteId"
            simple: "${routeId}"
        - setHeader:
            name: "MessageSize"
            simple: "${body.length()}"
        
        # Create comprehensive error log message
        - setHeader:
            name: "DetailedErrorMessage"
            simple: "Detailed error information - ExceptionClass: ${header.ExceptionClass}, Message: ${header.ExceptionMessage}, Step: ${header.ProcessingStep}, RouteId: ${header.RouteId}, ExchangeId: ${header.ExchangeId}, MessageSize: ${header.MessageSize}"
        
        # Log detailed error information to Kafka
        - setHeader:
            name: "LogMessage" 
            simple: "{\"level\":\"ERROR\",\"timestamp\":\"${header.ErrorTimestamp}\",\"correlationId\":\"${header.ErrorCorrelationId}\",\"step\":\"error-handler\",\"exceptionClass\":\"${header.ExceptionClass}\",\"exceptionMessage\":\"${header.ExceptionMessage}\",\"processingStep\":\"${header.ProcessingStep}\",\"routeId\":\"${header.RouteId}\",\"exchangeId\":\"${header.ExchangeId}\",\"messageSize\":\"${header.MessageSize}\",\"message\":\"${header.DetailedErrorMessage}\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.ErrorCorrelationId}&logMessage=${header.LogMessage}"
        - log:
            message: "${header.LogMessage}"
            loggingLevel: "ERROR"
        - setHeader:
            name: "LogMessage"
            simple: "{\"flowCode\":\"PACS008\",\"messageId\":\"${header.MessageId}\",\"step\":\"ERROR\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"queue\":\"pacs008.input.queue\"}"
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-flow-summary&brokers=kafka:29092&key=${header.CorrelationId}&logMessage=${header.LogMessage}"

        
        # Create comprehensive error record for monitoring
        - setHeader:
            name: "OriginalErrorBody"
            simple: "${body}"
        - setHeader:
            name: "ErrorRecordJson"
            simple: "{\"errorTimestamp\":\"${header.ErrorTimestamp}\",\"correlationId\":\"${header.ErrorCorrelationId}\",\"exceptionClass\":\"${header.ExceptionClass}\",\"exceptionMessage\":\"${header.ExceptionMessage}\",\"processingStep\":\"${header.ProcessingStep}\",\"routeId\":\"${header.RouteId}\",\"exchangeId\":\"${header.ExchangeId}\",\"messageSize\":\"${header.MessageSize}\",\"jmsMessageId\":\"${header.JMSMessageID}\",\"jmsCorrelationId\":\"${header.JMSCorrelationID}\",\"stackTrace\":\"${header.ExceptionStackTrace}\"}"
        - setBody:
            simple: "${header.ErrorRecordJson}"
        - to:
            uri: "kafka:pacs008-error?brokers=kafka:29092&key=${header.ErrorCorrelationId}"
        
        # Send to dead letter queue for manual intervention
        - setBody:
            simple: "${header.OriginalErrorBody}"
        - to:
            uri: "kafka:pixel-v2-dlq?brokers=kafka:29092&key=${header.ErrorCorrelationId}"
        
        # Final error log
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"ERROR\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.ErrorCorrelationId}\",\"step\":\"error-processing-complete\",\"message\":\"[PACS-008-ERROR] Error processing completed - sent to error topic and DLQ\"}"
        
        - to:
            uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=${header.ErrorCorrelationId}&logMessage=${header.LogMessage}"
        

# # Health Check Route
# - route:
#     id: "pacs008-health-check-route"
#     from:
#       uri: "timer:health?period=30000"
#       steps:
#         - setHeader:
#             name: "HealthCheckTimestamp"
#             simple: "${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}"
#         - setHeader:
#             name: "FlowStatus"
#             constant: "RUNNING"
#         - setHeader:
#             name: "LogMessage"
#             simple: "{\"level\":\"INFO\",\"timestamp\":\"${header.HealthCheckTimestamp}\",\"correlationId\":\"health-check\",\"step\":\"health-check\",\"message\":\"[PACS-008-HEALTH] Flow status check - Status: ${header.FlowStatus}, Timestamp: ${header.HealthCheckTimestamp}\"}"
#         - to:
#             uri: "kamelet:k-kafka-message-publisher?topic=pacs008-logs&brokers=kafka:29092&key=health-check&logMessage=${header.LogMessage}"
        # Optional: Send health status to monitoring queue
        # - to: "jms:queue:pacs008.monitoring.queue?connectionFactory=#activeMQConnectionFactory"