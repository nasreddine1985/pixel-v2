# YAML DSL for PACS-008 Log Processing Route
#
# This route consumes messages from the pacs008-logs Kafka topic
# and persists them to the database using k-db-tx kamelet

# Dependencies
#//DEPS com.pixel.v2:k-kafka-starter:1.0.1-SNAPSHOT
#//DEPS com.pixel.v2:k-db-tx:1.0.1-SNAPSHOT
#//DEPS org.postgresql:postgresql:42.7.2
#//DEPS org.apache.camel:camel-jdbc:4.16.0
#//DEPS org.apache.camel:camel-jackson:4.16.0

- beans:
  - name: "dataSource"
    type: "org.postgresql.ds.PGSimpleDataSource"
    properties:
      serverName: "pixel-v2-postgresql"
      portNumber: 5432
      databaseName: "pixelv2"
      user: "pixelv2"
      password: "pixelv2_secure_password"

- route:
        id: "pacs008-log-kafka-consumer-route"
        from:
          uri: "kafka:pacs008-logs"
          parameters:
            brokers: "kafka:29092"
            groupId: "pacs008-log-processor-group"
            autoOffsetReset: "latest"
            maxPollRecords: 500
            sessionTimeoutMs: 30000
            autoCommitIntervalMs: 5000
          steps:
            - to:
                uri: "direct:kafka-message-processing"

- route:
        id: "pacs008-flow-summary-kafka-consumer-route"
        from:
          uri: "kafka:pacs008-flow-summary"
          parameters:
            brokers: "kafka:29092"
            groupId: "pacs008-flow-summary-processor-group"
            autoOffsetReset: "latest"
            maxPollRecords: 500
            sessionTimeoutMs: 30000
            autoCommitIntervalMs: 5000
          steps:
            - to:
                uri: "direct:kafka-flow-summary-processing"

- route:
        id: "pacs008-log-processing-route"
        from:
          uri: "direct:kafka-message-processing"
          steps:
            
            # Parse the JSON log message and extract fields for database persistence
            - setHeader:
                name: "MessageId"
                simple: "${uuid}"
            - setHeader:
                name: "CorrelationId"
                simple: "LOG-${date:now:yyyyMMddHHmmssSSS}"
            - setHeader:
                name: "MessageType"
                constant: "PACS008_LOG"
            - setHeader:
                name: "Source"
                constant: "KAFKA"
            - setHeader:
                name: "payload"
                simple: "${body}"
            - setHeader:
                name: "ProcessingStatus"
                constant: "RECEIVED"
            
            # Persist log message to database using k-db-tx-logevents kamelet
            - to:
                uri: "kamelet:k-db-tx-logevents"
                parameters:
                  messageId: "${header.MessageId}"
                  correlationId: "${header.CorrelationId}"
                  messageType: "${header.MessageType}"
                  source: "${header.Source}"
                  payload: "${header.payload}"
                  processingStatus: "${header.ProcessingStatus}"
                  dataSource: "#dataSource"
                  tableName: "pixel_v2.log_event"

- route:
        id: "pacs008-flow-summary-processing-route"
        from:
          uri: "direct:kafka-flow-summary-processing"
          steps:
            
            # Parse the JSON flow summary message and extract fields for database persistence
            - setHeader:
                name: "MessageId"
                simple: "${uuid}"
            - setHeader:
                name: "CorrelationId"
                simple: "FLOW-${date:now:yyyyMMddHHmmssSSS}"
            - setHeader:
                name: "MessageType"
                constant: "PACS008_FLOW_SUMMARY"
            - setHeader:
                name: "Source"
                constant: "KAFKA"
            - setHeader:
                name: "payload"
                simple: "${body}"
            - setHeader:
                name: "ProcessingStatus"
                constant: "RECEIVED"
            
            # Persist flow summary message to database using k-db-tx-flow-summary kamelet
            - to:
                uri: "kamelet:k-db-tx-flow-summary"
                parameters:
                  messageId: "${header.MessageId}"
                  correlationId: "${header.CorrelationId}"
                  messageType: "${header.MessageType}"
                  source: "${header.Source}"
                  payload: "${header.payload}"
                  processingStatus: "${header.ProcessingStatus}"
                  dataSource: "#dataSource"
                  tableName: "pixel_v2.tb_flow_summary"