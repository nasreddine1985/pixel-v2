# PIXEL-V2 Simple PACS008 Route for Spring Boot
# Basic route to test JMS connectivity and message processing

- beans:
  - name: "jmsConnectionFactory"
    type: "org.apache.activemq.ActiveMQConnectionFactory"
    properties:
      brokerURL: "tcp://pixel-v2-activemq:61616"
      username: "admin"
      password: "admin"
      trustAllPackages: true
  - name: "dataSource"
    type: "org.postgresql.ds.PGSimpleDataSource"
    properties:
      serverName: "pixel-v2-postgresql"
      portNumber: 5432
      databaseName: "pixelv2"
      user: "pixelv2"
      password: "pixelv2_secure_password"

# Simple PACS-008 Processing Route - Basic JMS to Kafka
- route:
    id: "pacs008-processing-flow-simple"
    errorHandler:
      deadLetterChannel:
        deadLetterUri: "direct:pacs008-error-handler"
        useOriginalMessage: true
    from:
      uri: "jms:queue:pacs008.input.queue?connectionFactory=#jmsConnectionFactory&concurrentConsumers=1"
      steps:
        # Step 1: Initial logging 
        - setHeader:
            name: "MessageId"
            simple: "${header.JMSMessageID}"
        - setHeader:
            name: "CorrelationId"
            simple: "${header.JMSMessageID}"
        - log:
            message: "[PACS-008] Message received - CorrelationId: ${header.CorrelationId}, MessageId: ${header.MessageId}"
            loggingLevel: "INFO"
            
        # Step 2: Log to Kafka
        - setHeader:
            name: "LogMessage"
            simple: "{\"level\":\"INFO\",\"timestamp\":\"${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}\",\"correlationId\":\"${header.CorrelationId}\",\"step\":\"message-received\",\"message\":\"[PACS-008] Message received from JMS - Queue: pacs008.input.queue\"}"
        - to:
            uri: "kafka:pacs008-logs?brokers=kafka:29092&key=${header.CorrelationId}"
            
        # Step 3: Simple pass-through to output Kafka topic
        - to:
            uri: "kafka:pacs008-output?brokers=kafka:29092&key=${header.CorrelationId}"
        - log:
            message: "[PACS-008] Message sent to Kafka output topic - CorrelationId: ${header.CorrelationId}"
            loggingLevel: "INFO"
            
# Error Handler Route
- route:
    id: "pacs008-error-handler-route"
    from:
      uri: "direct:pacs008-error-handler"
      steps:
        - setHeader:
            name: "ErrorTimestamp"
            simple: "${date:now:yyyy-MM-dd'T'HH:mm:ss.SSSZ}"
        - setHeader:
            name: "ErrorCorrelationId"
            simple: "${header.CorrelationId}"
        - setHeader:
            name: "ExceptionMessage"
            simple: "${exception.message}"
        - log:
            message: "[PACS-008-ERROR] Error processing message - CorrelationId: ${header.ErrorCorrelationId}, Exception: ${header.ExceptionMessage}"
            loggingLevel: "ERROR"
        - to:
            uri: "kafka:pacs008-error?brokers=kafka:29092&key=${header.ErrorCorrelationId}"